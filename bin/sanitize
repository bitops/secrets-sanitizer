#!/usr/bin/env ruby
lib = File.expand_path('../../lib', __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require 'optparse'
require 'sanitizer'
require 'yaml'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: example.rb [options]"

  opts.on("-sSECRETDIR", "--secret-dir=SECRETDIR", "Secret file directory") do |s|
    options[:sec_dir] = s
  end

  opts.on("-pPATTERNFILE", "--pattern-file=PATTERNFILE", "File with regex patterns to match secret keys") do |p|
    options[:pattern_file] = p
  end

  opts.on("-mMANIFEST", "--manifest=MANIFEST", "Manifest yaml") do |m|
    options[:manifest] = m
  end
end.parse!

yaml = YAML.load_file(options[:manifest])
config_pattern = File.read(options[:pattern_file])

json_secret_file = File.join(
  File.expand_path(options[:sec_dir]),
  "/secrets-#{File.basename(options[:manifest], '.yml')}.json"
)

replacer = Sanitizer::MustacheReplacer.new(config_pattern, yaml)

Sanitizer::YamlTraverser.traverse(yaml) do |k, v, h|
  replacer.replace(k, v, h)
end

File.open(options[:manifest], 'w') do |file|
  file.write replacer.manifest_yaml
end

File.open(json_secret_file, 'w') do |file|
  file.write replacer.secrets_json
end


#!/usr/bin/env ruby
lib = File.expand_path('../../lib', __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require 'optparse'
require 'sanitizer'
require 'yaml'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: example.rb [options]"

  opts.on("-sSECRETDIR", "--secret-dir=SECRETDIR", "Secret file directory") do |s|
    options[:sec_dir] = s
  end

  opts.on("-pPATTERNFILE", "--pattern-file=PATTERNFILE", "File with regex patterns to match secret keys") do |p|
    options[:pattern_file] = p
  end

  opts.on("-mMANIFEST", "--manifest=MANIFEST", "Manifest yaml") do |m|
    options[:manifest] = m
  end
  
  opts.on("-dINPUT_DIR", "--input-dir=INPUTDIR", "Input directory of yaml files") do |i|
    options[:input_dir] = i
  end
end.parse!

unless options[:manifest].nil?
  Sanitizer::SanitizeExecutor.execute(options[:manifest], options[:pattern_file], options[:sec_dir])
else
  if options[:input_dir].nil?
    puts 'Input dir or manifest are not specifiled'
    exit 1
  else
    Dir.glob(File.join(options[:input_dir], '**', '*.yml')) do |f|
      puts "Sanitizing file #{f}..."
      Sanitizer::SanitizeExecutor.execute(f, options[:pattern_file], options[:sec_dir])
    end
  end
end

